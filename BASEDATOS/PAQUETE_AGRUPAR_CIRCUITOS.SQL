CREATE OR REPLACE PACKAGE ENERGISEMCALI.AGRUPAR_CIRCUITOS
AS
-- Package header
 PROCEDURE BORRAR;
 PROCEDURE PROCESAR(pcircuito IN VARCHAR2);
END AGRUPAR_CIRCUITOS;

CREATE OR REPLACE PACKAGE BODY ENERGISEMCALI.AGRUPAR_CIRCUITOS
AS
-- Package body
 PROCEDURE BORRAR AS
 BEGIN
    DELETE FROM HIT_AFFECTED;
    DELETE  HIT_LINE;
    DELETE  HIT_LONGITUDES;
    COMMIT;
    EXECUTE IMMEDIATE 'TRUNCATE TABLE HIT_NODE';
    --DELETE HIT_NODE;
    COMMIT;
 END BORRAR;

PROCEDURE EXPORTAR AS
BEGIN

INSERT INTO HIT_NODE
SELECT
	'MT-' || MT.CODIGOAPOYO || '-' || MT.CODIGONODOMT NID,
	NVL(A.PINTADOAPOYO, A.CODIGOAPOYO) NNAME,
	TO_NUMBER(REPLACE(MT.CODIGOCIRCUITO, ' ')) SUB_ID,
	ASCII(MT.CODIGONODOMT)|| MT.CODIGOAPOYO ABB_INT_ID,
	TA.NOMBRETIPOAPOYO,
	NT.TENSION,
	A.X AS XN_1,
	A.Y AS YN_1,
	A.LON AS LON,
	A.LAT AS LAT
FROM
	NODOMT MT,
	APOYO A,
	ESTRUCTURA E,
	CIRCUITO CI,
	NIVELTENSION NT,
	TIPOAPOYO TA,
	HIT_AFFECTED HA
WHERE
	MT.CODIGOAPOYO = A.CODIGOAPOYO
	AND A.CODIGOESTRUCTURA = E.CODIGOESTRUCTURA
	AND MT.CODIGOCIRCUITO = CI.CODIGOCIRCUITO
	AND CI.CODIGONIVELTENSION = NT.CODIGONIVELTENSION
	AND CI.CODIGOCIRCUITO = HA.CODIGOCIRCUITO
	AND E.CODIGOTIPOAPOYO = TA.CODIGOTIPOAPOYO
 UNION
    /*APOYOS BT*/
SELECT
	'BT-' || BT.CODIGOAPOYO || '-' || BT.CODIGONODOBT NID,
	NVL(A.PINTADOAPOYO, A.CODIGOAPOYO) NNAME,
	TO_NUMBER(REPLACE(NM.CODIGOCIRCUITO, ' ')) AS SUB_ID,
	/* SOLO SE DEBE INSERTAR TRAFOS QUE PERTENESCAN A CIRUITOS DE HIT_AFFECTED*/
	ASCII(BT.CODIGONODOBT)|| BT.CODIGOAPOYO ABB_INT_ID,
	TA.NOMBRETIPOAPOYO,
	NT.TENSION ,
	A.X AS XN_1,
	A.Y AS YN_1,
	A.LON AS LON,
	A.LAT AS LAT
FROM
	NODOBT BT,
	APOYO A,
	ESTRUCTURA E,
	TRAFODIS T,
	NODOMT NM,
	NIVELTENSION NT,
	TIPOAPOYO TA,
	HIT_AFFECTED HA
WHERE
	BT.CODIGOAPOYO = A.CODIGOAPOYO
	AND A.CODIGOESTRUCTURA = E.CODIGOESTRUCTURA
	AND BT.CODIGOTRAFODIS = T.CODIGOTRAFODIS
	AND T.CODIGOAPOYO1 = NM.CODIGOAPOYO
	AND T.CODIGONODOMT = NM.CODIGONODOMT
	AND NM.CODIGOCIRCUITO = HA.CODIGOCIRCUITO
	AND NT.CODIGONIVELTENSION = T.CODIGONIVELTENSION
	AND E.CODIGOTIPOAPOYO = TA.CODIGOTIPOAPOYO
UNION
/*CIRCUITOS SWING */
SELECT
	'SO' || C.IDALIMENTADOR AS NID,
	'SO-' || C.IDALIMENTADOR AS NNAME,
	TO_NUMBER(REPLACE(C.CODIGOCIRCUITO, ' ')) SUB_ID,
	ASCII('s')|| TO_CHAR(C.IDALIMENTADOR) AS ABB_INT_ID,
	'Subestacion',
	34.5,
	A.X + 2 AS XN_1,
	A.Y + 2 AS YN_1,
	A.LON AS LON,
	A.LAT AS LAT
FROM
	CIRCUITO C,
	NODOMT NM,
	APOYO A,
	NIVELTENSION NT,
	HIT_AFFECTED HA
WHERE
	C.CODIGOAPOYO = NM.CODIGOAPOYO
	AND C.CODIGONODOMT = NM.CODIGONODOMT
	AND C.CODIGOAPOYO = A.CODIGOAPOYO
	AND C.CODIGOCIRCUITO = HA.CODIGOCIRCUITO
	AND C.CODIGONIVELTENSION = NT.CODIGONIVELTENSION
UNION  
  /*INTERRUPTORES*/
SELECT
	'MT-' || MT.CODIGOAPOYO || '-' || MT.CODIGONODOMT NID,
	NVL(A.PINTADOAPOYO, A.CODIGOAPOYO) NNAME,
	TO_NUMBER(REPLACE(N1.CODIGOCIRCUITO, ' ')) SUB_ID,
	ASCII(MT.CODIGONODOMT)|| MT.CODIGOAPOYO ABB_INT_ID,
	'INTERRUPTORDIS',
	NT.TENSION,
	A.X AS XN_1,
	A.Y AS YN_1,
	A.LON AS LON,
	A.LAT AS LAT
FROM
	INTERRUPTORDIS I,
	NODOMT N1,
	NODOMT MT,
	APOYO A,
	ESTRUCTURA E,
	CIRCUITO CI,
	NIVELTENSION NT,
	HIT_AFFECTED HA
WHERE
	I.CODIGOAPOYO1 = MT.CODIGOAPOYO
	AND I.CODIGONODOMT1 = MT.CODIGONODOMT
	AND I.CODIGOAPOYO2 = N1.CODIGOAPOYO
	AND I.CODIGONODOMT2 = N1.CODIGONODOMT
	AND N1.CODIGOCIRCUITO = HA.CODIGOCIRCUITO
	AND N1.CODIGOCIRCUITO <> MT.CODIGOCIRCUITO
	AND MT.CODIGOAPOYO = A.CODIGOAPOYO
	AND A.CODIGOESTRUCTURA = E.CODIGOESTRUCTURA
	AND DECODE(MT.CODIGOCIRCUITO, ' ', N1.CODIGOCIRCUITO, DECODE(MT.CODIGOCIRCUITO, 'NUEVO', N1.CODIGOCIRCUITO, MT.CODIGOCIRCUITO)) = CI.CODIGOCIRCUITO
	AND CI.CODIGONIVELTENSION = NT.CODIGONIVELTENSION
	AND MT.CODIGOCIRCUITO NOT IN 
		(
	 	SELECT CODIGOCIRCUITO
	 	FROM HIT_AFFECTED  
		)
UNION                
SELECT
	'MT-' || MT.CODIGOAPOYO || '-' || MT.CODIGONODOMT NID,
	NVL(A.PINTADOAPOYO, A.CODIGOAPOYO) NNAME,
	TO_NUMBER(REPLACE(N1.CODIGOCIRCUITO, ' ')) SUB_ID,
	ASCII(MT.CODIGONODOMT)|| MT.CODIGOAPOYO ABB_INT_ID,
	'INTERRUPTORDIS',
	NT.TENSION,
	A.X AS XN_1,
	A.Y AS YN_1,
	A.LON AS LON,
	A.LAT AS LAT
FROM
	INTERRUPTORDIS I,
	NODOMT N1,
	NODOMT MT,
	APOYO A,
	ESTRUCTURA E,
	CIRCUITO CI,
	NIVELTENSION NT,
	HIT_AFFECTED HA
WHERE
	I.CODIGOAPOYO1 = MT.CODIGOAPOYO
	AND I.CODIGONODOMT1 = MT.CODIGONODOMT
	AND I.CODIGOAPOYO2 = N1.CODIGOAPOYO
	AND I.CODIGONODOMT2 = N1.CODIGONODOMT
	AND N1.CODIGOCIRCUITO = HA.CODIGOCIRCUITO
	AND N1.CODIGOCIRCUITO <> MT.CODIGOCIRCUITO
	AND MT.CODIGOAPOYO = A.CODIGOAPOYO
	AND A.CODIGOESTRUCTURA = E.CODIGOESTRUCTURA
	AND DECODE(MT.CODIGOCIRCUITO, ' ', N1.CODIGOCIRCUITO, DECODE(MT.CODIGOCIRCUITO, 'NUEVO', N1.CODIGOCIRCUITO, MT.CODIGOCIRCUITO)) = CI.CODIGOCIRCUITO
	AND CI.CODIGONIVELTENSION = NT.CODIGONIVELTENSION
	AND MT.CODIGOCIRCUITO NOT IN
        (
          SELECT CODIGOCIRCUITO
          FROM HIT_AFFECTED
        ) ;

COMMIT;

/*CARGAS
	INSERT INTO HIT_NODE
    
	SELECT
	'CA-' || C.CODIGOAPOYO || '-' || C.CODIGOCARGA NID,
	NVL(C.PINTADOAPOYO, C.CODIGOAPOYO) NNAME,
	TO_NUMBER(REPLACE(NM.CODIGOCIRCUITO, ' ')) AS SUB_ID,
	ASCII('z')|| C.CODIGOCARGA AS ABB_INT_ID,
	ASCII('z')|| C.CODIGOCARGA AS NFPOS,
	C.X AS XN_1,
	C.Y AS YN_1
FROM
	HIT_CARGA C,
	NODOBT NB,
	TRAFODIS T,
	NODOMT NM,
	HIT_AFFECTED HA
WHERE
	C.CODIGOAPOYO = NB.CODIGOAPOYO
	AND C.CODIGONODOBT = NB.CODIGONODOBT
	AND NB.CODIGOTRAFODIS = T.CODIGOTRAFODIS
	AND T.CODIGOAPOYO1 = NM.CODIGOAPOYO
	AND T.CODIGONODOMT = NM.CODIGONODOMT
	AND T.CODIGOESTADOINFRAESTRUCTURA = 1
	AND NM.CODIGOESTADOINFRAESTRUCTURA = 1
	AND NM.CODIGOCIRCUITO = HA.CODIGOCIRCUITO
        AND NOT exists (
        	SELECT hn.ABB_INT_ID FROM hit_node hn
       		 WHERE hn.ABB_INT_ID = ASCII('z')||C.CODIGOCARGA
         );
        COMMIT;
   */

--SELECT COUNT(1) FROM HIT_NODE;
              
/* HIT_LINE*/
INSERT INTO HIT_LINE (ID,NAME ,ABB_INT_ID,NO_KEY_1,NO_KEY_2,LENGTH,TIPO_CONDUCTOR,CAPACIDAD_AMP,CODIGOAPOYO1,CODIGOAPOYO2 )
SELECT 'TD-'||TM.CODIGOTRAFODIS ID,
'TD-'||TM.CODIGOTRAFODIS NAME,
ASCII('t')||TM.CODIGOTRAFODIS ABB_INT_ID,
ASCII(TM.CODIGONODOMT)||TM.CODIGOAPOYO1 NO_KEY_1,
ASCII(TM.CODIGONODOBT)||TM.CODIGOAPOYO2 NO_KEY_2,
-1 LENGTH,
101 TIPO_CONDUCTOR,
1 CAPACIDAD_AMP,
TM.CODIGOAPOYO1,
TM.CODIGOAPOYO2
FROM TRAFODIS TM,NODOMT NM, CIRCUITO CI, HIT_AFFECTED HA
WHERE  TM.CODIGOAPOYO1= NM.CODIGOAPOYO
AND TM.CODIGONODOMT = NM.CODIGONODOMT
AND NM.CODIGOCIRCUITO=CI.CODIGOCIRCUITO
AND CI.CODIGOCIRCUITO = HA.CODIGOCIRCUITO
AND TM.CODIGOESTADOINFRAESTRUCTURA=1
AND NM.CODIGOESTADOINFRAESTRUCTURA=1;
       
COMMIT;

INSERT INTO HIT_LINE (ID,NAME ,ABB_INT_ID,NO_KEY_1,NO_KEY_2,LENGTH,TIPO_CONDUCTOR,CAPACIDAD_AMP,CODIGOAPOYO1,CODIGOAPOYO2 )
SELECT 'ID-'||TM.CODIGOINTERRUPTORDIS ID,
'ID-'||TM.CODIGOINTERRUPTORDIS NAME,
ASCII('i')||TM.CODIGOINTERRUPTORDIS ABB_INT_ID,
ASCII(TM.CODIGONODOMT1)||TM.CODIGOAPOYO1 NO_KEY_1,
ASCII(TM.CODIGONODOMT2)||TM.CODIGOAPOYO2 NO_KEY_2,
-1 LENGTH,
101 TIPO_CONDUCTOR,
1 CAPACIDAD_AMP,
TM.CODIGOAPOYO1,
TM.CODIGOAPOYO2
FROM INTERRUPTORDIS TM,NODOMT NM, CIRCUITO CI, HIT_AFFECTED HA
WHERE  TM.CODIGOAPOYO1= NM.CODIGOAPOYO
AND TM.CODIGONODOMT1 = NM.CODIGONODOMT
AND NM.CODIGOCIRCUITO=CI.CODIGOCIRCUITO
AND CI.CODIGOCIRCUITO = HA.CODIGOCIRCUITO
AND TM.CODIGOESTADOINFRAESTRUCTURA=1
AND NM.CODIGOESTADOINFRAESTRUCTURA=1
UNION
SELECT 'ID-'||TM.CODIGOINTERRUPTORDIS ID,
'ID-'||TM.CODIGOINTERRUPTORDIS NAME,
ASCII('i')||TM.CODIGOINTERRUPTORDIS ABB_INT_ID,
ASCII(TM.CODIGONODOMT1)||TM.CODIGOAPOYO1 NO_KEY_1,
ASCII(TM.CODIGONODOMT2)||TM.CODIGOAPOYO2 NO_KEY_2,
-1 LENGTH,
101 TIPO_CONDUCTOR,
1 CAPACIDAD_AMP,
TM.CODIGOAPOYO1,
TM.CODIGOAPOYO2
FROM INTERRUPTORDIS TM,NODOMT NM, CIRCUITO CI, HIT_AFFECTED HA
WHERE  TM.CODIGOAPOYO2= NM.CODIGOAPOYO
AND TM.CODIGONODOMT2 = NM.CODIGONODOMT
AND NM.CODIGOCIRCUITO=CI.CODIGOCIRCUITO
AND CI.CODIGOCIRCUITO = HA.CODIGOCIRCUITO
AND TM.CODIGOESTADOINFRAESTRUCTURA=1
AND NM.CODIGOESTADOINFRAESTRUCTURA=1;

COMMIT;

INSERT INTO HIT_LINE (ID,NAME ,ABB_INT_ID,NO_KEY_1,NO_KEY_2,LENGTH,TIPO_CONDUCTOR,CAPACIDAD_AMP,CODIGOAPOYO1,CODIGOAPOYO2 )
SELECT 'MT-'||TM.CODIGOTRAMOMT ID,
SUBSTR('MT-'||TO_CHAR(TM.CODIGOTRAMOMT)||'-'||CI.NOMBRECIRCUITO,1,38) NAME,
ASCII('m')||TM.CODIGOTRAMOMT ABB_INT_ID,
ASCII(TM.CODIGONODOMT1)||TM.CODIGOAPOYO1 NO_KEY_1,
ASCII(TM.CODIGONODOMT2)||TM.CODIGOAPOYO2 NO_KEY_2,
-1 LENGTH,
101 TIPO_CONDUCTOR,
1 CAPACIDAD_AMP,
TM.CODIGOAPOYO1,
TM.CODIGOAPOYO2
FROM TRAMOMT TM, ESTRUCTURA ES,NODOMT NM, CIRCUITO CI, HIT_AFFECTED HA
WHERE TM.CODIGOESTRUCTURATRAMO=ES.CODIGOESTRUCTURA
AND TM.CODIGOAPOYO1= NM.CODIGOAPOYO
AND TM.CODIGONODOMT1 = NM.CODIGONODOMT
AND NM.CODIGOCIRCUITO=CI.CODIGOCIRCUITO
AND CI.CODIGOCIRCUITO = HA.CODIGOCIRCUITO
AND TM.CODIGOESTADOINFRAESTRUCTURA=1
AND NM.CODIGOESTADOINFRAESTRUCTURA=1;

COMMIT;

INSERT INTO HIT_LINE (ID,NAME ,ABB_INT_ID,NO_KEY_1,NO_KEY_2,LENGTH,TIPO_CONDUCTOR,CAPACIDAD_AMP,CODIGOAPOYO1,CODIGOAPOYO2 )
SELECT TO_NUMBER(REPLACE(C.CODIGOCIRCUITO,' ',''))||'-'||C.NOMBRECIRCUITO AS ID,
TO_NUMBER(REPLACE(C.CODIGOCIRCUITO,' ',''))||'-'||C.NOMBRECIRCUITO AS NAME,
ASCII('s')||C.CODIGOAPOYO AS ABB_INT_ID,
ASCII('s')||C.IDALIMENTADOR AS NO_KEY_1,
ASCII(C.CODIGONODOMT)||C.CODIGOAPOYO AS NO_KEY_2,
-1 LENGTH,
101 TIPO_CONDUCTOR,
1 CAPACIDAD_AMP,
0,
0
FROM CIRCUITO C,  HIT_AFFECTED HA
WHERE C.CODIGOCIRCUITO = HA.CODIGOCIRCUITO 
AND C.CODIGOESTADOINFRAESTRUCTURA=1;

COMMIT;




--138
INSERT INTO HIT_LONGITUDES
SELECT
	hl.ABB_INT_ID,
	CASE
		WHEN sqrt(power(hn1.XN_1 - hn2.XN_1, 2)+power(hn1.YN_1 - hn2.YN_1, 2)) = 0 THEN 1.2  
		ELSE ROUND(sqrt(power(hn1.XN_1 - hn2.XN_1, 2)+power(hn1.YN_1 - hn2.YN_1, 2)),3)
	END
FROM HIT_LINE hl 
JOIN HIT_NODE hn1 ON hn1.ABB_INT_ID = hl.NO_KEY_1 
JOIN HIT_NODE hn2 ON hn2.ABB_INT_ID = hl.NO_KEY_2 ;

COMMIT;


UPDATE HIT_LINE hl
SET hl.LENGTH = (
	SELECT hll.LENGTH
	FROM HIT_LONGITUDES hll
	WHERE hl.ABB_INT_ID = hll.ABB_INT_ID
)
WHERE EXISTS (
	SELECT 1
	FROM HIT_LONGITUDES hll
	WHERE hl.ABB_INT_ID = hll.ABB_INT_ID
);

COMMIT;	
	
END EXPORTAR;


PROCEDURE PROCESAR(pcircuito IN VARCHAR2) AS
  v_sub_id NUMBER;
BEGIN
  -- Proceder con BORRAR
	BORRAR;
  -- Validar el CODIGOCIRCUITO
  BEGIN
    SELECT TO_NUMBER(REGEXP_REPLACE(C.CODIGOCIRCUITO, '[^0-9]', '')) INTO v_sub_id
    FROM CIRCUITO C
    WHERE C.CODIGOCIRCUITO = pcircuito;
  EXCEPTION
    WHEN NO_DATA_FOUND THEN
      RAISE_APPLICATION_ERROR(-20002, 'Código de circuito no válido: ' || pcircuito);
  END;
  -- Insertar en HIT_AFFECTED si válido
  INSERT INTO HIT_AFFECTED (SUB_ID, CODIGOCIRCUITO)
  SELECT TO_NUMBER(REGEXP_REPLACE(C.CODIGOCIRCUITO, '[^0-9]', '')) AS SUB_ID, 
         C.CODIGOCIRCUITO
  FROM CIRCUITO C
  WHERE C.CODIGOCIRCUITO = pcircuito;
  COMMIT;
  -- Proceder con EXPORTAR
  EXPORTAR;
  COMMIT;
EXCEPTION
  WHEN OTHERS THEN
    DECLARE
      MSG_ERROR VARCHAR2(4000);
    BEGIN
      MSG_ERROR := 'Se ha presentado el siguiente problema: ' || SQLCODE || '  ' || SQLERRM || ' ' || DBMS_UTILITY.FORMAT_ERROR_BACKTRACE;
      RAISE_APPLICATION_ERROR(-20001, MSG_ERROR);
    END;
END PROCESAR;
END AGRUPAR_CIRCUITOS;